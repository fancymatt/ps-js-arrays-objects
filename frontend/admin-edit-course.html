<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Study - Globomantics Company Onboarding</title>
        <link rel="stylesheet" href="reset.css">
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <header class="header">
            <nav class="main-nav">
                <ul>
                    <li><a href="course-list.html">Course List</a></li>
                    <li><a href="notebook.html">Your Notebook</a></li>
                </ul>
            </nav>
            <nav class="admin-nav">
                <ul>
                    <li><a href="admin-course-list.html">Admin</a></li>
                </ul>
            </nav>
        </header>
        <div class="title"><h1>Admin - Edit Course</h1></div>
        <div class="course-form">
            <h2>Course Metadata</h2>
            <div class="course-metadata-form">
                <div class="form-field">
                    <label>Course Title</label>
                    <input id="course-title" type="text" value="title">
                </div>
                <div class="form-field">
                    <label>Course ID</label>
                    <input id="course-id" type="text" value="id">
                </div>
            </div>
            <h2>Content Blocks</h2>
            <div id="edit-course-form">

            </div>
        </div>
    </body>
    <script>
        let editCourseForm = document.getElementById("edit-course-form");
        let courseTitleField = document.getElementById("course-title");
        let courseIdField = document.getElementById("course-id");
        let contentBlocks = [];
        let currentCourse = null;

        const parseJsonAsCourse = function(json) {
            const coursePrototype = {
                id: "no id",
                title: "no title",
                author: "no author"
            };

            const newCourse = Object.create(coursePrototype);
            
            newCourse.id = json.id;
            newCourse.title = json.title;
            newCourse.author = json.author;

            currentCourse = newCourse;
            
            contentBlocks = [];
            json.content.forEach(contentBlock => parseJsonAsContentBlock(contentBlock));
        };

        const parseJsonAsContentBlock = function(json) {
            const contentBlockPrototype = {
                id: "no id",
                title: "no title",
                content: "no content",
                bookmarked: false,
                bookmark: function() {
                    fetch('http://localhost:8000/api/bookmark', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ "id": this.id })
                    })
                    .then(response => {
                        if (response.status == "200") {
                            this.bookmarked = true
                            updateCardDisplay();
                        }
                    });
                },
                unbookmark: function() {
                    fetch('http://localhost:8000/api/unbookmark', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ "id": this.id })
                    })
                    .then(response => {
                        if (response.status == "200") {
                            this.bookmarked = false
                            updateCardDisplay();
                        }
                    });
                }
            };

            const newContentBlock = Object.create(contentBlockPrototype);
            Object.assign(newContentBlock, json);
            contentBlocks.push(newContentBlock);
        }

        let fetchCourse = async function() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            fetch('http://localhost:8000/api/course/' + urlParams.get('id'))
                .then(response => response.json())
                .then(json => {
                    parseJsonAsCourse(json.course);
                    updateCourseAdminDisplay();
                });
        };

        let appendSaveDbButton = function() {
            const li = document.createElement("li");
            let createBtn = document.createElement("button");
            createBtn.innerHTML = "Save Changes to DB";
            createBtn.classList.add("button");
            createBtn.addEventListener('click', () => {
                saveToDb();
            });
            li.appendChild(createBtn);
            courseListRoot.appendChild(li);
        }

        let saveCourse = async function() {
            let courseToSave = {};
            // remind me why I don't just use currentCourse?
            Object.assign(courseToSave, currentCourse);
            courseToSave.content = contentBlocks;

            // TODO: course id should not be changeable
            fetch('http://localhost:8000/api/course/' + currentCourse.id, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(courseToSave)
            })
                .then(fetchCourse);
        };

        let updateCourseAdminDisplay = function() {
            courseTitleField.value = currentCourse.title;
            courseTitleField.addEventListener('input', (event) => {
                currentCourse.title = event.target.value;
            });

            courseIdField.value = currentCourse.id;

            editCourseForm.innerHTML = '';
            contentBlocks.forEach(contentBlock => {
                editCourseForm.appendChild(createElementForContentBlock(contentBlock));
            });
            appendSaveCourseButton();
        };

        let appendSaveCourseButton = function() {
            const createBtn = document.createElement("button");
            createBtn.innerHTML = "Save Changes";
            createBtn.classList.add("button");
            createBtn.addEventListener('click', () => {
                saveCourse();
            });
            editCourseForm.appendChild(createBtn);
        }

        const setContentBlockPropertyFromField = function(contentBlockId, property, value) {
            const foundContentBlock = contentBlocks.find(contentBlock => contentBlock.id == contentBlockId);
            if (foundContentBlock == null) console.error("Did not find content block with this id");
            foundContentBlock[property] = value;
        }

        const createElementForContentBlock = function(contentBlockObject) {
            let form = document.createElement("div");
            form.classList.add("content-block-form");

            let titleField = document.createElement("div");
            titleField.classList.add("form-field");
            let titleLabel = document.createElement("label");
            titleLabel.innerHTML = "Title";
            let titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.value = contentBlockObject.title;
            titleInput.addEventListener('input', (event) => {
                setContentBlockPropertyFromField(contentBlockObject.id, "title", event.target.value);
            });

            titleField.appendChild(titleLabel);
            titleField.appendChild(titleInput);

            let idField = document.createElement("div");
            idField.classList.add("form-field");
            let idLabel = document.createElement("label");
            idLabel.innerHTML = "ID";
            let idInput = document.createElement("input");
            idInput.type = "text";
            idInput.value = contentBlockObject.id;

            idField.appendChild(idLabel);
            idField.appendChild(idInput);

            let descField = document.createElement("div");
            descField.classList.add("form-field");
            let descLabel = document.createElement("label");
            descLabel.innerHTML = "Description";
            let descTA = document.createElement("textarea");
            descTA.innerHTML = contentBlockObject.content;
            descTA.addEventListener('input', (event) => {
                setContentBlockPropertyFromField(contentBlockObject.id, "content", event.target.value);
            });

            descField.appendChild(descLabel);
            descField.appendChild(descTA);

            form.appendChild(titleField);
            form.appendChild(idField);
            form.appendChild(descField);

            return form;
        };

        fetchCourse();
    </script>
</html>